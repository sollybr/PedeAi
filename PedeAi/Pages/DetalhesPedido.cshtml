@page "/DetalhesPedido"
@model DetalhesPedidoModel
@{
    ViewData["Title"] = "Detalhes do Pedido";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="~/css/DetalhesPedido.css" asp-append-version="true" />
}

<h2>Pedido #@Model.PedidoId</h2>
<div class="map-wrapper">
    <div id="map"></div>
</div>

<div class="mt-3">
    <button id="definirManualBtn" class="btn btn-secondary">Definir Localização Manualmente</button>
</div>

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let marcadorUsuario;
        let userLat = null;
        let userLng = null;

        const fallbackLat = -3.786624;  // Coordenadas de fallback
        const fallbackLng = -38.553138;

        function inicializarMapa(lat, lng) {
            map = L.map('map').setView([lat, lng], 18);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://carto.com/">Carto</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            atualizarMarcadorUsuario(lat, lng);

            map.whenReady(() => map.invalidateSize());
            window.addEventListener('load', () => setTimeout(() => map.invalidateSize(), 30));
        }

        function atualizarMarcadorUsuario(lat, lng) {
            userLat = lat;
            userLng = lng;

            if (marcadorUsuario) {
                marcadorUsuario.setLatLng([lat, lng]);
            } else {
                marcadorUsuario = L.marker([lat, lng], { draggable: false }).addTo(map)
                    .bindPopup('Você está aqui').openPopup();
            }

            atualizarLinkRota();
        }

        // function atualizarLinkRota() {
        //     const rotaURL = `https:www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${destinoLat},${destinoLng}&travelmode=walking`;
        //     const link = document.getElementById('rotaLink');
        //     if (link) {
        //         link.href = rotaURL;
        //         link.style.display = 'inline-block';
        //     }
        // }

        function erroLocalizacao(err) {
            console.warn("Erro de geolocalização:", err);
            alert("Não foi possível obter sua localização automaticamente. Clique no botão abaixo para definir manualmente.");
        }

        document.getElementById('definirManualBtn').addEventListener('click', () => {
            alert("Clique no mapa para definir sua localização.");
            map.on('click', function (e) {
                atualizarMarcadorUsuario(e.latlng.lat, e.latlng.lng);
                map.off('click'); // só permite um clique
            });
        });

        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    inicializarMapa(lat, lng);
                    atualizarMarcadorUsuario(lat, lng);
                },
                err => {
                    erroLocalizacao(err);
                    inicializarMapa(fallbackLat, fallbackLng);
                },
                { timeout: 30 }
            );
        } else {
            // alert("Seu navegador não suporta geolocalização.");
            inicializarMapa(fallbackLat, fallbackLng);
        }
    </script>
}
